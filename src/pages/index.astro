---
import Layout from "../layouts/Layout.astro";
import { getBlogPosts } from "../lib/contentful";
import InstagramLogo from "phosphor-astro/InstagramLogo.astro";
import XLogo from "phosphor-astro/XLogo.astro";
import LinkedinLogo from "phosphor-astro/LinkedinLogo.astro";
import GithubLogo from "phosphor-astro/GithubLogo.astro";

const posts = await getBlogPosts();

// Helper to extract text from Contentful rich text
function extractTextFromRichText(node: any): string {
  if (!node) return "";
  if (typeof node === "string") return node;
  if (Array.isArray(node)) return node.map(extractTextFromRichText).join(" ");
  if (node.nodeType === "text") return node.value;
  if (node.content) return extractTextFromRichText(node.content);
  return "";
}

function getReadingTime(body: any): number {
  if (!body) return 1;
  const text = extractTextFromRichText(body);
  const wordCount = text.trim().split(/\s+/).length;
  return Math.max(1, Math.ceil(wordCount / 200));
}

// Get unique categories from posts
const categories = Array.from(new Set(posts.map(post => post.fields.category).filter(Boolean)));
const allCategories = ["Tümü", ...categories];
---

<Layout 
  title="MultiGroup Bülten Arşivi"
  description="MultiGroup Developer Community'nin bülten arşivi. Yazılım geliştirme, teknoloji ve developer deneyimleri hakkında kaliteli içerikler."
  ogImage="/opengraph-image.png"
  ogImageAlt="MultiGroup Bülten Arşivi"
>
  <main class="min-h-screen bg-white text-black font-montserrat">
    <!-- Header Section -->
    <header class="px-4 pt-18 pb-8 flex flex-col items-center">
      <img src="/logo-wide-dark.webp" alt="MultiGroup Logo" class="h-14 md:h-20 mb-6" />
      <p class="italic text-center text-gray-500 text-lg mb-4">
        "Where Developers Become Together"
      </p>
      <div class="flex flex-col gap-2 justify-center items-center mb-8 text-sm md:text-base text-gray-600">
        <!-- First row -->
        <div class="flex gap-2 justify-center items-center">
          <a
            href="https://links.devmultigroup.com/"
            aria-label="Instagram"
            class="hover:text-red-600 transition-all duration-300"
            target="_blank"
          >
            Biz Kimiz?
          </a>
          <span>/</span>
          <a
            href="https://www.instagram.com/devmultigroup/"
            aria-label="Instagram"
            class="hover:text-red-600 transition-all duration-300"
            target="_blank"
          >
            Instagram
          </a>
          <span>/</span>
          <a
            href="https://x.com/devmultigroup"
            aria-label="X"
            class="hover:text-red-600 transition-all duration-300"
            target="_blank"
          >
            Twitter
          </a>
        </div>
        <!-- Second row -->
        <div class="flex gap-2 justify-center items-center">
          <a
            href="https://www.linkedin.com/company/devmultigroup/"
            aria-label="LinkedIn"
            class="hover:text-red-600 transition-all duration-300"
            target="_blank"
          >
            LinkedIn
          </a>
          <span>/</span>
          <a
            href="https://github.com/Developer-MultiGroup"
            aria-label="Github"
            class="hover:text-red-600 transition-all duration-300"
            target="_blank"
          >
            Github
          </a>
          <span>/</span>
          <a
            href="https://etkinlik.devmultigroup.com/"
            aria-label="Etkinlikler"
            class="hover:text-red-600 transition-all duration-300"
            target="_blank"
          >
            Etkinlikler
          </a>
        </div>
      </div>
    </header>

    <!-- Main Content Area -->
    <div class="max-w-6xl mx-auto px-4">
      <!-- Category Filter and Search Bar -->
      <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8 gap-4">
        <!-- Mobile: Search Bar + Dropdown (2:1 ratio) -->
        <div class="flex gap-2 md:hidden">
          <div class="flex-1">
            <input
              id="searchInput"
              type="text"
              placeholder="Ara..."
              class="w-full h-10 px-4 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-red-500"
              autocomplete="off"
            />
          </div>
          <div class="w-1/3">
            <select
              id="categoryDropdown"
              class="w-full h-10 px-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-red-500 bg-white"
            >
              {allCategories.map((category) => (
                <option value={category === "Tümü" ? "" : String(category)}>
                  {category}
                </option>
              ))}
            </select>
          </div>
        </div>

        <!-- Desktop: Category Filter -->
        <div class="hidden md:flex flex-wrap gap-4 order-2 md:order-1">
          {allCategories.map((category) => (
            <button
              class="category-filter px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 transition-colors"
              data-category={category === "Tümü" ? "" : category}
            >
              {category}
            </button>
          ))}
        </div>
        
        <!-- Desktop: Search Bar -->
        <div class="hidden md:flex items-center gap-2 order-1 md:order-2">
          <input
            id="searchInputDesktop"
            type="text"
            placeholder="Ara..."
            class="w-full md:w-auto px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-red-500"
            autocomplete="off"
          />
        </div>
      </div>

      <!-- Blog Posts Grid -->
      <div id="blogList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {
          posts.map((post) => {
            const { title, description, writers, body, cover, category, date } = post.fields;
            const createdAt = post.sys.createdAt;
            const formattedDate = date ? 
              new Date(date as unknown as string).toLocaleDateString("tr-TR", {
                year: "numeric",
                month: "long",
                day: "numeric",
              }) :
              new Date(createdAt).toLocaleDateString("tr-TR", {
                year: "numeric",
                month: "long",
                day: "numeric",
              });
            const readingTime = getReadingTime(body);
            const coverUrl = (cover as any)?.fields?.file?.url;
            
            return (
              <article
                class="blog-item border border-gray-200 rounded-lg overflow-hidden hover:border-red-500 hover:shadow-lg transition-all duration-300"
                data-title={title}
                data-description={description}
                data-writers={Array.isArray(writers) ? writers.join(", ") : ""}
                data-category={category || ""}
              >
                <a href={`/p/${post.fields.slug}`} class="block group">
                  <!-- Cover Image -->
                  <div class="aspect-[16/9] bg-gray-100 overflow-hidden">
                    {coverUrl ? (
                      <img
                        src={`https:${coverUrl}`}
                        alt={String(title) || "Untitled Post"}
                        class="w-full h-full object-cover"
                      />
                    ) : (
                      <div class="w-full h-full bg-gradient-to-br from-gray-200 to-gray-300 flex items-center justify-center">
                        <div class="text-center text-gray-500">
                          <svg class="w-12 h-12 mx-auto mb-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" />
                          </svg>
                          <p class="text-xs font-medium">MultiGroup</p>
                        </div>
                      </div>
                    )}
                  </div>
                  
                  <!-- Content -->
                  <div class="p-4">
                    <!-- Metadata -->
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-xs text-gray-500">
                        {Array.isArray(writers) && writers.length > 0 
                          ? writers.length === 1 
                            ? writers[0] 
                            : `${writers.length} yazar`
                          : "Yazar bilgisi yok"} · {formattedDate}
                      </span>
                      <span class="text-xs text-gray-400">{readingTime} dk</span>
                    </div>
                    
                    <!-- Title -->
                    <h2 class="text-lg font-semibold group-hover:text-red-600 transition-colors mb-2 line-clamp-2">
                      {String(title) || "Untitled Post"}
                    </h2>
                    
                    <!-- Description -->
                    <p class="text-gray-700 text-sm line-clamp-2 mb-3">
                      {typeof description === "string" ? description : ""}
                    </p>
                    
                    <!-- Category -->
                    {category && (
                      <span class="inline-block px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded">
                        {category}
                      </span>
                    )}
                  </div>
                </a>
              </article>
            );
          })
        }
      </div>
    </div>
  </main>
</Layout>

<script>
  let currentCategory = "";
  
  function filterPosts() {
    const searchInput = document.getElementById('searchInput') as HTMLInputElement;
    const searchInputDesktop = document.getElementById('searchInputDesktop') as HTMLInputElement;
    
    // Get search term from either mobile or desktop input
    const searchTerm = (searchInput?.value || searchInputDesktop?.value || '').toLowerCase().trim();
    const posts = document.querySelectorAll('.blog-item') as NodeListOf<HTMLElement>;
    
    posts.forEach(post => {
      const title = post.dataset.title?.toLowerCase() || '';
      const description = post.dataset.description?.toLowerCase() || '';
      const writers = post.dataset.writers?.toLowerCase() || '';
      const category = post.dataset.category || '';
      
      const matchesSearch = !searchTerm || 
        title.includes(searchTerm) || 
        description.includes(searchTerm) || 
        writers.includes(searchTerm);
      
      const matchesCategory = !currentCategory || category === currentCategory;
      
      if (matchesSearch && matchesCategory) {
        post.style.display = 'block';
      } else {
        post.style.display = 'none';
      }
    });
  }
  
  function setActiveCategory(category: string) {
    currentCategory = category;
    
    // Update active button styling
    document.querySelectorAll('.category-filter').forEach(btn => {
      btn.classList.remove('bg-red-600', 'text-white');
      btn.classList.add('border-gray-300', 'hover:bg-gray-50');
    });
    
    const activeBtn = document.querySelector(`[data-category="${category}"]`);
    if (activeBtn) {
      activeBtn.classList.add('bg-red-600', 'text-white');
      activeBtn.classList.remove('border-gray-300', 'hover:bg-gray-50');
    }
    
    filterPosts();
  }
  
  // Initialize everything when DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    // Set up search input event listeners (both mobile and desktop)
    const searchInput = document.getElementById('searchInput') as HTMLInputElement;
    const searchInputDesktop = document.getElementById('searchInputDesktop') as HTMLInputElement;
    
    if (searchInput) {
      searchInput.addEventListener('input', filterPosts);
      searchInput.addEventListener('keyup', filterPosts);
      searchInput.addEventListener('change', filterPosts);
    }
    
    if (searchInputDesktop) {
      searchInputDesktop.addEventListener('input', filterPosts);
      searchInputDesktop.addEventListener('keyup', filterPosts);
      searchInputDesktop.addEventListener('change', filterPosts);
    }
    
    // Set up category dropdown (mobile)
    const categoryDropdown = document.getElementById('categoryDropdown') as HTMLSelectElement;
    if (categoryDropdown) {
      categoryDropdown.addEventListener('change', () => {
        setActiveCategory(categoryDropdown.value);
      });
    }
    
    // Set up category filter buttons (desktop)
    document.querySelectorAll('.category-filter').forEach(btn => {
      btn.addEventListener('click', () => {
        setActiveCategory((btn as HTMLElement).dataset.category || '');
      });
    });
    
    // Set initial active state for "Tümü" button (desktop)
    const allBtn = document.querySelector('[data-category=""]');
    if (allBtn) {
      allBtn.classList.add('bg-red-600', 'text-white');
      allBtn.classList.remove('border-gray-300', 'hover:bg-gray-50');
    }
    
    // Set initial dropdown value (mobile)
    if (categoryDropdown) {
      categoryDropdown.value = '';
    }
    
    // Initial filter to show all posts
    filterPosts();
  });
</script>
